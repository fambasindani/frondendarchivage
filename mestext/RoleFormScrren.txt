import React, { useState, useEffect } from 'react';
import { useUser } from '../Composant/UserContext';
import Swal from 'sweetalert2';
import {  
  FaKey, 
  FaInfoCircle,
  FaArrowLeft,
  FaSave
} from 'react-icons/fa';
import { Link } from 'react-router-dom';

const RoleForm = ({ role, onClose, onSuccess }) => {
  const { permissions, addRole, updateRole } = useUser();
  const [formData, setFormData] = useState({
    nom: '',
    description: '',
    permissions: []
  });
  const [loading, setLoading] = useState(false);
  const [errors, setErrors] = useState({});

  useEffect(() => {
    if (role) {
      setFormData({
        nom: role.nom,
        description: role.description || '',
        permissions: role.permissions || []
      });
    }
  }, [role]);

  const validateForm = () => {
    const newErrors = {};
    
    if (!formData.nom.trim()) {
      newErrors.nom = 'Le nom du rôle est requis';
    }
    
    if (formData.nom.length > 50) {
      newErrors.nom = 'Le nom ne doit pas dépasser 50 caractères';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setLoading(true);

    try {
      if (role) {
        await updateRole(role.id, formData);
        Swal.fire('Succès', 'Rôle mis à jour avec succès', 'success');
      } else {
        await addRole(formData);
        Swal.fire('Succès', 'Rôle créé avec succès', 'success');
      }
      onSuccess();
    } catch (error) {
      Swal.fire('Erreur', error.message || 'Une erreur est survenue', 'error');
    } finally {
      setLoading(false);
    }
  };

  const PermissionCategory = ({ category, permissions }) => {
    const categoryPermissions = permissions.filter(perm => 
      perm.code.toLowerCase().startsWith(category.toLowerCase())
    );

    if (categoryPermissions.length === 0) return null;

    return (
      <div className="permission-category mb-4">
        <h6 className="font-weight-bold text-uppercase text-muted mb-3">
          <FaKey className="mr-2" />
          {category.replace('_', ' ').toUpperCase()}
        </h6>
        <div className="row">
          {categoryPermissions.map(permission => (
            <div key={permission.id} className="col-md-6 mb-3">
              <div className={`permission-item-card ${
                formData.permissions.includes(permission.id) 
                  ? 'selected' 
                  : ''
              }`}>
                <div className="d-flex align-items-start">
                  <div className="mr-3 mt-1">
                    <input
                      type="checkbox"
                      className="form-check-input"
                      id={`perm-${permission.id}`}
                      checked={formData.permissions.includes(permission.id)}
                      onChange={(e) => {
                        const newPermissions = e.target.checked
                          ? [...formData.permissions, permission.id]
                          : formData.permissions.filter(id => id !== permission.id);
                        setFormData({...formData, permissions: newPermissions});
                      }}
                      disabled={loading}
                    />
                  </div>
                  <div className="flex-grow-1">
                    <label 
                      className="font-weight-bold mb-1 d-block cursor-pointer"
                      htmlFor={`perm-${permission.id}`}
                    >
                      {permission.code}
                    </label>
                    <p className="text-muted small mb-0">
                      {permission.description || 'Aucune description'}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  const getCategories = () => {
    const categories = new Set();
    permissions.forEach(perm => {
      const category = perm.code.split('_')[0];
      categories.add(category);
    });
    return Array.from(categories);
  };

  return (
    <div className="role-form-page">
      {/* Header */}
      <div className="row mb-4">
        <div className="col-12">
          <div className="d-flex justify-content-between align-items-center">
            <div>
              <h2 className="h3 mb-0">
                {role ? 'Modifier le rôle' : 'Créer un nouveau rôle'}
              </h2>
              <p className="text-muted mb-0">
                {role ? 'Modifiez les informations du rôle' : 'Définissez un nouveau rôle avec ses permissions'}
              </p>
            </div>
            
            <Link 
              to="/gestion-utilisateurs/roles"
              className="btn btn-outline-secondary"
            >
              <FaArrowLeft className="mr-1" />
              Retour à la liste
            </Link>
          </div>
        </div>
      </div>

      <div className="row">
        <div className="col-lg-8">
          <div className="card shadow-sm border-0">
            <div className="card-body">
              <form onSubmit={handleSubmit}>
                {/* Informations de base */}
                <div className="mb-4">
                  <h5 className="card-title mb-3">Informations du rôle</h5>
                  
                  <div className="form-group">
                    <label className="font-weight-bold">
                      Nom du rôle <span className="text-danger">*</span>
                    </label>
                    <input
                      type="text"
                      className={`form-control ${errors.nom ? 'is-invalid' : ''}`}
                      value={formData.nom}
                      onChange={(e) => {
                        setFormData({...formData, nom: e.target.value});
                        if (errors.nom) setErrors({...errors, nom: ''});
                      }}
                      placeholder="Ex: Administrateur, Modérateur, etc."
                      disabled={loading}
                    />
                    {errors.nom && (
                      <div className="invalid-feedback">{errors.nom}</div>
                    )}
                  </div>

                  <div className="form-group">
                    <label className="font-weight-bold">Description</label>
                    <textarea
                      className="form-control"
                      rows="3"
                      value={formData.description}
                      onChange={(e) => setFormData({...formData, description: e.target.value})}
                      placeholder="Décrivez le rôle et ses responsabilités..."
                      disabled={loading}
                    />
                    <small className="text-muted">
                      <FaInfoCircle className="mr-1" />
                      Cette description aidera les autres administrateurs à comprendre l'objectif de ce rôle.
                    </small>
                  </div>
                </div>

                {/* Permissions */}
                <div className="mb-4">
                  <div className="d-flex justify-content-between align-items-center mb-3">
                    <h5 className="card-title mb-0">
                      <FaKey className="mr-2" />
                      Permissions
                    </h5>
                    <span className="badge badge-primary">
                      {formData.permissions.length} sélectionnée(s)
                    </span>
                  </div>

                  <div className="permissions-container">
                    {getCategories().map(category => (
                      <PermissionCategory 
                        key={category}
                        category={category}
                        permissions={permissions}
                      />
                    ))}
                  </div>

                  {permissions.length === 0 && (
                    <div className="alert alert-info">
                      <FaInfoCircle className="mr-2" />
                      Aucune permission disponible. Créez d'abord des permissions.
                    </div>
                  )}
                </div>

                {/* Actions */}
                <div className="d-flex justify-content-end border-top pt-4">
                  <Link 
                    to="/gestion-utilisateurs/roles"
                    className="btn btn-outline-secondary mr-3"
                    disabled={loading}
                  >
                    Annuler
                  </Link>
                  <button 
                    type="submit" 
                    className="btn btn-primary"
                    disabled={loading}
                  >
                    {loading ? (
                      <>
                        <span className="spinner-border spinner-border-sm mr-2"></span>
                        {role ? 'Mise à jour...' : 'Création...'}
                      </>
                    ) : (
                      <>
                        <FaSave className="mr-2" />
                        {role ? 'Mettre à jour le rôle' : 'Créer le rôle'}
                      </>
                    )}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        {/* Sidebar - Récapitulatif */}
        <div className="col-lg-4">
          <div className="sticky-top" style={{ top: '20px' }}>
            <div className="card shadow-sm border-0 mb-4">
              <div className="card-header bg-light">
                <h6 className="mb-0">Récapitulatif</h6>
              </div>
              <div className="card-body">
                <div className="mb-3">
                  <h6 className="text-muted mb-2">Nom du rôle</h6>
                  <p className="font-weight-bold">
                    {formData.nom || <span className="text-muted">Non défini</span>}
                  </p>
                </div>

                <div className="mb-3">
                  <h6 className="text-muted mb-2">Permissions sélectionnées</h6>
                  <div className="selected-permissions-list">
                    {formData.permissions.length > 0 ? (
                      <>
                        {formData.permissions.slice(0, 5).map(permId => {
                          const perm = permissions.find(p => p.id === permId);
                          return perm ? (
                            <div key={perm.id} className="mb-2">
                              <span className="badge badge-info d-inline-block text-left">
                                {perm.code}
                              </span>
                            </div>
                          ) : null;
                        })}
                        {formData.permissions.length > 5 && (
                          <div className="text-center mt-2">
                            <span className="text-muted">
                              + {formData.permissions.length - 5} autres
                            </span>
                          </div>
                        )}
                      </>
                    ) : (
                      <p className="text-muted mb-0">Aucune permission sélectionnée</p>
                    )}
                  </div>
                </div>

                <div className="alert alert-light border mt-3">
                  <small>
                    <FaInfoCircle className="mr-1" />
                    <strong>Conseil :</strong> Sélectionnez uniquement les permissions nécessaires au rôle.
                    Trop de permissions peuvent compromettre la sécurité.
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <style jsx>{`
        .role-form-page {
          padding: 20px;
          background: #f8f9fa;
          min-height: calc(100vh - 76px);
        }
        
        .permissions-container {
          max-height: 500px;
          overflow-y: auto;
          padding: 15px;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          background: white;
        }
        
        .permission-item-card {
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 6px;
          transition: all 0.2s;
          cursor: pointer;
        }
        
        .permission-item-card:hover {
          border-color: #007bff;
          background-color: rgba(0, 123, 255, 0.05);
        }
        
        .permission-item-card.selected {
          border-color: #007bff;
          background-color: rgba(0, 123, 255, 0.1);
        }
        
        .cursor-pointer {
          cursor: pointer;
        }
        
        .selected-permissions-list {
          max-height: 200px;
          overflow-y: auto;
        }
        
        /* Scrollbar styling */
        .permissions-container::-webkit-scrollbar,
        .selected-permissions-list::-webkit-scrollbar {
          width: 6px;
        }
        
        .permissions-container::-webkit-scrollbar-track,
        .selected-permissions-list::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 3px;
        }
        
        .permissions-container::-webkit-scrollbar-thumb,
        .selected-permissions-list::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 3px;
        }
        
        .permissions-container::-webkit-scrollbar-thumb:hover,
        .selected-permissions-list::-webkit-scrollbar-thumb:hover {
          background: #a1a1a1;
        }
        
        @media (max-width: 992px) {
          .role-form-page {
            padding: 15px;
          }
          
          .sticky-top {
            position: static !important;
          }
        }
      `}</style>
    </div>
  );
};

export default RoleForm;